<script src="https://unpkg.com/vue@2.4.2"></script>
<script src="https://unpkg.com/moment@2.18.1"></script>
<script>
  var app = new Vue({
    el: '#app',
    mounted: function() {
      google.script.run.withSuccessHandler((calendarData) => {
        this.calendars = calendarData.calendars;
        this.selectedCalendarIndex = calendarData.primaryIndex;
        this.message = 'loaded!'
      }).getCalendars();
    },
    methods: {
      selectCalendar(index) {
        this.selectedCalendarIndex = index;
      },
      onPressSearch() {
        google.script.run.withSuccessHandler((resultData) => {
          this.timeSpent = resultData.time;
          this.events = resultData.events;
        })
        .withFailureHandler((error) => { console.log(error) })
        .getTime(this.calendars[this.selectedCalendarIndex].name, this.filterForm.title, this.filterForm.weeksBefore);
      },
      getDate(date) {
        return moment(date).format('MMMM Do YYYY');
      },
      getTime(date) {
        return moment(date).format('h:mm a');
      },
      getColor(colorId) {
        return this.eventColors[colorId].color;
      }
    },
    computed: {
      timeSpentParsed: function() {
        var timeSpentMinutes = this.timeSpent / (60 * 1000);
        var minutes = Math.floor(timeSpentMinutes % 60);
        var hours = Math.floor((timeSpentMinutes / 60) % 24);
        var days = Math.floor((timeSpentMinutes / (24 * 60)));
        
        var resultArray = [];
        if(days != 0) resultArray.push(days + ' days');
        if(hours != 0) resultArray.push(hours + ' hours');
        if(minutes != 0) resultArray.push(minutes + ' minutes');
        
        var result = '';
        
        for(var i = 0; i < resultArray.length; i++) {
          result += resultArray[i];
          if(i != resultArray.length - 1) result += ', ';
        }
        
        return result || 'No events matched your search!';
      },
      currentCalendarName: function() {
        return this.selectedCalendarIndex != -1 ? this.calendars[this.selectedCalendarIndex].name : '';
      },
      currentCalendarColor: function() {
        return this.selectedCalendarIndex != -1 ? this.calendars[this.selectedCalendarIndex].color : '';
      }
    },
    data: {
      message: 'Hello Vue!',
      selectedCalendarIndex: -1,
      timeSpent: -1,
      events: [],
      calendars: [],
      filterForm: {
        title: '',
        weeksBefore: 1
      },
      eventColors: {
        1: { name: 'Pale Blue', color: '#a4bdfc' },
        2: { name: 'Pale Green', color: '#7ae7bf' },
        3: { name: 'Purple', color: '#bdadff' },
        4: { name: 'Pale Red', color: '#ff887c' },
        5: { name: 'Yellow', color: '#fbd75b' },
        6: { name: 'Orange', color: '#ffb878' },
        7: { name: 'Turquoise', color: '#46d6db' },
        8: { name: 'Gray', color: '#e1e1e1' },
        9: { name: 'Bold Blue', color: '#5484ed' },
        10: { name: 'Bold Green', color: '#51b749' },
        11: { name: 'Bold Red', color: '#dc2127' }
      }
    }
  });
</script>